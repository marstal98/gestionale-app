name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Test e Qualit√† del Codice
  test:
    name: Test Suite & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: gestionale-app-coverage
        
    - name: Lint check
      run: npm run lint || echo "Lint not configured yet"
      continue-on-error: true

  # Job 2: Build Web App (will be enabled after web setup)
  build-web:
    name: Build Web Version
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && false # Disabled for now
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Expo
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
        
    - name: Build web app
      run: npx expo export -p web
      
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist

  # Job 3: Build Mobile
  build-mobile:
    name: Build Mobile Apps
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[mobile-build]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
        
    - name: Pre-build validation
      run: npm run pre-build
      
    - name: Build Android Preview
      run: eas build --platform android --profile preview --non-interactive
      
    - name: Build iOS Preview  
      run: eas build --platform ios --profile preview --non-interactive
      
    - name: Comment PR with build links
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üöÄ Mobile builds triggered! Check [EAS Dashboard](https://expo.dev/builds) for progress.'
          });

  # Job 4: Notificazioni e Report
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.test.result == 'success'
      run: |
        echo "‚úÖ Test completati con successo!"
        echo "üìä Coverage report disponibile"
        echo "üöÄ Pronto per il deploy!"
        
    - name: Notify failure
      if: needs.test.result == 'failure'
      run: |
        echo "‚ùå Test falliti. Controlla i log per dettagli."
        exit 1